%% You can view and edit this diagram in your browser using the Mermaid Live Editor:
%% https://mermaid.live

graph TD
    User[("User's Mailbox")]

    subgraph "Local System (Watcher)"
        Watcher["Email Polling Service<br/>(email_langgraph_integration.js)"]
    end
    
    subgraph "Google Cloud Platform (GCP)"
        PubSub[("Pub/Sub Topic<br/>'incoming-messages'")]
        CloudFunc["Python Cloud Function<br/>- Distributed Lock Logic<br/>- LangGraph Agent Execution<br/>- Firestore State Management"]
        Firestore[("Firestore Database<br/>- Conversation State<br/>- Distributed Locks")]
        EmailFunc["GCP Email Function<br/>(Sends Agent's Response)"]
    end

    User -- "1. Sends/Receives Email" --- Watcher
    Watcher -- "2. Publishes event on new email" --> PubSub
    PubSub -- "3. Triggers Cloud Function" --> CloudFunc
    CloudFunc -- "4. Reads/Writes State & Locks" <--> Firestore
    CloudFunc -- "5. Calls Email API" --> EmailFunc
    EmailFunc -- "6. Sends Final Response" --> User 
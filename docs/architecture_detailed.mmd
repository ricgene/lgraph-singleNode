graph TB
    %% External Services
    GMAIL[Gmail IMAP/SMTP]
    FIREBASE[(Firebase Firestore)]
    PUBSUB[Google Cloud Pub/Sub]
    
    %% Cloud Functions (Deployed)
    WATCHER_FUNC[email_watcher_function/index.js<br/>email-watcher Cloud Function<br/>(Node.js, HTTP Trigger)]
    PROCESS_FUNC[cloud_function/main.py<br/>process-incoming-email Cloud Function<br/>(Python, Pub/Sub Trigger)]
    EMAIL_FUNC[simple_email_function/main.py<br/>send-email-simple Cloud Function<br/>(Python, HTTP Trigger)]
    
    %% Cloud Scheduler
    SCHEDULER[Cloud Scheduler<br/>email-watcher-job<br/>(Every 2 minutes)]
    
    %% Agent Logic
    AGENT_LOGIC[cloud_function/agent.py<br/>Agent Logic & State Management]
    
    %% Local Development Files (Not Deployed)
    LOCAL_WATCHER[email_watcher_minimal.js<br/>Local Development Version]
    LANGGRAPH_SERVER[langgraph_server.py<br/>Local LangGraph Server]
    
    %% Configuration & Environment
    ENV[.env<br/>Environment Variables]
    DEPLOY_CMDS[gcloudFunctionsDeployProcess-incoming.txt<br/>Deployment Commands]
    
    %% Data Flow Connections
    
    %% Cloud Scheduler Flow
    SCHEDULER -->|HTTP POST| WATCHER_FUNC
    WATCHER_FUNC -->|IMAP Polling| GMAIL
    WATCHER_FUNC -->|Publish Message| PUBSUB
    
    %% Pub/Sub Processing Flow
    PUBSUB -->|Trigger| PROCESS_FUNC
    PROCESS_FUNC -->|Import & Call| AGENT_LOGIC
    PROCESS_FUNC -->|HTTP POST| EMAIL_FUNC
    EMAIL_FUNC -->|SMTP| GMAIL
    
    %% State Management
    PROCESS_FUNC -->|Read/Write| FIREBASE
    AGENT_LOGIC -->|Read/Write| FIREBASE
    
    %% Local Development (Alternative)
    LOCAL_WATCHER -->|IMAP Polling| GMAIL
    LOCAL_WATCHER -->|Publish Message| PUBSUB
    LANGGRAPH_SERVER -->|HTTP POST| AGENT_LOGIC
    
    %% Environment & Configuration
    ENV --> WATCHER_FUNC
    ENV --> PROCESS_FUNC
    ENV --> EMAIL_FUNC
    ENV --> LOCAL_WATCHER
    
    %% Styling
    classDef deployed fill:#e8f5e8
    classDef external fill:#e1f5fe
    classDef local fill:#fff3e0
    classDef config fill:#fce4ec
    
    class WATCHER_FUNC,PROCESS_FUNC,EMAIL_FUNC,SCHEDULER deployed
    class GMAIL,FIREBASE,PUBSUB external
    class LOCAL_WATCHER,LANGGRAPH_SERVER local
    class ENV,DEPLOY_CMDS config
    
    %% Subgraphs for better organization
    subgraph "Deployed Cloud Functions"
        WATCHER_FUNC
        PROCESS_FUNC
        EMAIL_FUNC
    end
    
    subgraph "Cloud Services"
        SCHEDULER
        PUBSUB
        FIREBASE
    end
    
    subgraph "Local Development"
        LOCAL_WATCHER
        LANGGRAPH_SERVER
    end
    
    subgraph "External Services"
        GMAIL
    end 